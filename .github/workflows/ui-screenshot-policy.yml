name: ui-screenshot-policy

on:
  pull_request:
    branches: [main]
    types: [opened, edited, synchronize, reopened]

jobs:
  require-ui-screenshots:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: enforce screenshot attachments for ui changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
              },
            );

            const uiPatterns = [
              /^verily_app\/lib\//,
              /^verily_ui\/lib\//,
              /^verily_app\/assets\//,
              /^verily_ui\/assets\//,
            ];

            const changedUiFiles = files.filter((file) =>
              uiPatterns.some((pattern) => pattern.test(file.filename)),
            );

            if (changedUiFiles.length === 0) {
              core.notice('No UI files changed. Screenshot policy skipped.');
              return;
            }

            const body = pr.body || '';
            const markdownImageRegex = /!\[[^\]]*\]\((https?:\/\/[^)\s]+)\)/gi;
            const directImageLinkRegex = /https?:\/\/[^\s)]+\.(?:png|jpe?g|webp|gif)/gi;
            const imageUrls = new Set();

            for (const match of body.matchAll(markdownImageRegex)) {
              imageUrls.add(match[1]);
            }
            for (const match of body.matchAll(directImageLinkRegex)) {
              imageUrls.add(match[0]);
            }

            if (imageUrls.size === 0) {
              core.setFailed([
                'UI changes detected but no screenshot links were found in the PR description.',
                'Add screenshots under a `Screenshots` section before merging.',
              ].join(' '));
              return;
            }

            core.notice(
              `UI screenshot policy passed with ${imageUrls.size} screenshot link(s).`,
            );
